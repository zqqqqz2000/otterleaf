<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Overleaf Editor Iframe API 演示</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }
      .controls h3 {
        margin-top: 0;
        color: #333;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .input-group {
        margin: 10px 0;
      }
      .input-group label {
        display: inline-block;
        width: 100px;
        font-weight: bold;
      }
      .input-group input,
      .input-group textarea {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
        width: 200px;
      }
      .input-group textarea {
        width: 300px;
        height: 60px;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .iframe-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Overleaf Editor Iframe API 演示</h1>

      <div class="status info">
        <strong>说明：</strong> 请将下面的 iframe URL 替换为您的实际 Overleaf
        项目 URL。此 iframe API 直接调用
        <code>window.overleafEditorApi</code> 中注册的 API 方法。
      </div>

      <div class="controls">
        <h3>基本操作</h3>
        <button onclick="getSelection()">获取选中文本</button>
        <button onclick="getDocument()">获取文档内容</button>
        <button onclick="recompile()">重新编译</button>
      </div>

      <div class="controls">
        <h3>文本操作</h3>
        <div class="input-group">
          <label>起始位置:</label>
          <input type="number" id="fromPos" value="0" min="0" />
        </div>
        <div class="input-group">
          <label>结束位置:</label>
          <input type="number" id="toPos" value="10" min="0" />
        </div>
        <div class="input-group">
          <label>新文本:</label>
          <textarea id="newText" placeholder="输入要替换的文本...">
Hello World!</textarea
          >
        </div>
        <button onclick="setSelection()">设置选中</button>
        <button onclick="replaceText()">替换文本</button>
        <button onclick="suggestChange()">建议修改</button>
      </div>

      <div class="controls">
        <h3>建议修改管理</h3>
        <div class="input-group">
          <label>修改ID:</label>
          <input type="text" id="changeId" placeholder="从建议修改响应中获取" />
        </div>
        <button onclick="acceptChange()">接受修改</button>
        <button onclick="rejectChange()">拒绝修改</button>
      </div>

      <div class="controls">
        <h3>日志</h3>
        <button onclick="clearLog()">清空日志</button>
        <div id="log" class="log"></div>
      </div>

      <div class="iframe-container">
        <iframe
          id="overleaf-editor"
          src="http://localhost"
          width="100%"
          height="600px"
          frameborder="0"
        >
        </iframe>
      </div>
    </div>

    <script>
      // 配置
      const OVERLEAF_ORIGIN = 'http://localhost' // 请替换为您的实际域名
      const IFRAME_ID = 'overleaf-editor'

      // 状态管理
      let isIframeLoaded = false
      let pendingCalls = new Map()
      let lastChangeId = null

      // 日志功能
      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = document.createElement('div')
        logEntry.innerHTML = `[${timestamp}] ${message}`
        logEntry.style.color =
          type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333'
        logElement.appendChild(logEntry)
        logElement.scrollTop = logElement.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
      }

      // 消息监听器
      window.addEventListener('message', function (event) {
        const { type, callId, success, result, error } = event.data

        if (type === 'apiResponse' && pendingCalls.has(callId)) {
          const { resolve, reject } = pendingCalls.get(callId)
          pendingCalls.delete(callId)

          if (success) {
            log(`API 调用成功: ${JSON.stringify(result)}`, 'success')
            resolve(result)
          } else {
            log(`API 调用失败: ${error}`, 'error')
            reject(new Error(error))
          }
        }
      })

      // iframe 加载完成
      document.getElementById(IFRAME_ID).addEventListener('load', function () {
        isIframeLoaded = true
        log('Overleaf 编辑器已加载', 'success')
      })

      // API 调用函数
      function callEditorApi(api, method, params = []) {
        console.log(api, method, params, 'call')
        if (!isIframeLoaded) {
          log('编辑器尚未加载完成，请稍后再试', 'error')
          return Promise.reject(new Error('编辑器未加载'))
        }

        return new Promise((resolve, reject) => {
          const callId =
            'call_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)

          pendingCalls.set(callId, { resolve, reject })

          const iframe = document.getElementById(IFRAME_ID)
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(
              {
                type: 'apiCall',
                api: api,
                method: method,
                params: params,
                callId: callId,
              },
              OVERLEAF_ORIGIN
            )

            log(`发送 API 调用: ${api}.${method}(${JSON.stringify(params)})`)
          } else {
            reject(new Error('Iframe 未找到或未加载'))
          }
        })
      }

      // 具体 API 方法
      async function getSelection() {
        try {
          const result = await callEditorApi('editor', 'getSelection')
          log(`选中文本: ${JSON.stringify(result)}`, 'success')
        } catch (error) {
          log(`获取选中文本失败: ${error.message}`, 'error')
        }
      }

      async function setSelection() {
        const from = parseInt(document.getElementById('fromPos').value)
        const to = parseInt(document.getElementById('toPos').value)

        try {
          await callEditorApi('editor', 'setSelection', [from, to])
          log(`选中范围设置为: ${from}-${to}`, 'success')
        } catch (error) {
          log(`设置选中范围失败: ${error.message}`, 'error')
        }
      }

      async function replaceText() {
        const from = parseInt(document.getElementById('fromPos').value)
        const to = parseInt(document.getElementById('toPos').value)
        const text = document.getElementById('newText').value

        try {
          await callEditorApi('editor', 'replaceText', [from, to, text])
          log(`文本替换成功: ${from}-${to} -> "${text}"`, 'success')
        } catch (error) {
          log(`文本替换失败: ${error.message}`, 'error')
        }
      }

      async function suggestChange() {
        const from = parseInt(document.getElementById('fromPos').value)
        const to = parseInt(document.getElementById('toPos').value)
        const text = document.getElementById('newText').value

        try {
          const result = await callEditorApi('editor', 'suggestChange', [
            from,
            to,
            text,
          ])
          lastChangeId = result.changeId
          document.getElementById('changeId').value = result.changeId
          log(`建议修改创建成功，ID: ${result.changeId}`, 'success')
        } catch (error) {
          log(`创建建议修改失败: ${error.message}`, 'error')
        }
      }

      async function acceptChange() {
        const changeId =
          document.getElementById('changeId').value || lastChangeId

        if (!changeId) {
          log('请先创建建议修改或输入修改ID', 'error')
          return
        }

        try {
          await callEditorApi('editor', 'acceptChange', [changeId])
          log(`建议修改已接受: ${changeId}`, 'success')
        } catch (error) {
          log(`接受建议修改失败: ${error.message}`, 'error')
        }
      }

      async function rejectChange() {
        const changeId =
          document.getElementById('changeId').value || lastChangeId

        if (!changeId) {
          log('请先创建建议修改或输入修改ID', 'error')
          return
        }

        try {
          await callEditorApi('editor', 'rejectChange', [changeId])
          log(`建议修改已拒绝: ${changeId}`, 'success')
        } catch (error) {
          log(`拒绝建议修改失败: ${error.message}`, 'error')
        }
      }

      async function getDocument() {
        try {
          const result = await callEditorApi('editor', 'getDocument', [true])
          log(
            `文档内容获取成功，长度: ${result.content.length} 字符`,
            'success'
          )
          log(
            `建议修改数量: ${result.changes ? result.changes.length : 0}`,
            'info'
          )
        } catch (error) {
          log(`获取文档内容失败: ${error.message}`, 'error')
        }
      }

      async function recompile() {
        try {
          await callEditorApi('editor', 'recompile', [{}])
          log('重新编译成功', 'success')
        } catch (error) {
          log(`重新编译失败: ${error.message}`, 'error')
        }
      }

      // 页面加载完成后的初始化
      window.addEventListener('load', function () {
        log('页面加载完成，等待 Overleaf 编辑器加载...', 'info')
        log('请确保将 iframe src 替换为您的实际 Overleaf 项目 URL', 'info')
      })
    </script>
  </body>
</html>
