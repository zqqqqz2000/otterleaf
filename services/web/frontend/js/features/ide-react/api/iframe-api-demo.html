<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Overleaf Editor Iframe API æ¼”ç¤º</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }
      .controls h3 {
        margin-top: 0;
        color: #333;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .input-group {
        margin: 10px 0;
      }
      .input-group label {
        display: inline-block;
        width: 100px;
        font-weight: bold;
      }
      .input-group input,
      .input-group textarea {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
        width: 200px;
      }
      .input-group textarea {
        width: 300px;
        height: 60px;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .iframe-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Overleaf Editor Iframe API æ¼”ç¤º</h1>

      <div class="status info">
        <strong>è¯´æ˜ï¼š</strong> è¯·å°†ä¸‹é¢çš„ iframe URL æ›¿æ¢ä¸ºæ‚¨çš„å®é™… Overleaf
        é¡¹ç›® URLã€‚æ­¤ iframe API ç›´æ¥è°ƒç”¨
        <code>window.overleafEditorApi</code> ä¸­æ³¨å†Œçš„ API æ–¹æ³•ã€‚ <br /><br />
        <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong>
        <ul style="margin: 5px 0; padding-left: 20px">
          <li>
            <strong>å¤–éƒ¨APIåˆ›å»ºé¡¹ç›®ï¼š</strong>
            é€šè¿‡å¤–éƒ¨APIåˆ›å»ºæ–°é¡¹ç›®ï¼Œéœ€è¦æä¾›API Tokenï¼Œåˆ›å»ºæˆåŠŸåè¿”å›é¡¹ç›®IDå’ŒURL
          </li>
          <li>
            <strong>æ–‡ä»¶ç®¡ç†ï¼š</strong>
            åˆ—å‡ºå½“å‰é¡¹ç›®ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œåœ¨é¡¹ç›®ä¸‹åˆ›å»ºæ–°æ–‡ä»¶å¤¹ï¼Œé‡å‘½åæ–‡ä»¶
          </li>
          <li>
            <strong>æ–‡ä»¶æ“ä½œï¼š</strong>
            ä¸‹è½½æ–‡ä»¶ï¼ˆè¾“å…¥æ–‡ä»¶IDï¼Œå¯é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶åï¼‰ï¼Œä¸Šä¼ æ–‡ä»¶ï¼ˆé€‰æ‹©æœ¬åœ°æ–‡ä»¶ï¼Œå¯é€‰æ‹©è‡ªå®šä¹‰æ–‡ä»¶åå’ŒæŒ‡å®šæ–‡ä»¶å¤¹IDï¼‰
          </li>
          <li>
            <strong>æ–‡ä»¶åˆ—è¡¨ï¼š</strong>
            æ˜¾ç¤ºé¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼ŒåŒ…æ‹¬ç±»å‹ã€è·¯å¾„ã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰ä¿¡æ¯ï¼Œå¯å¤åˆ¶æ–‡ä»¶ID
          </li>
        </ul>
      </div>

      <div class="controls">
        <h3>åŸºæœ¬æ“ä½œ</h3>
        <button onclick="getSelection()">è·å–é€‰ä¸­æ–‡æœ¬</button>
        <button onclick="getDocument()">è·å–æ–‡æ¡£å†…å®¹</button>
        <button onclick="recompile()">é‡æ–°ç¼–è¯‘</button>
      </div>

      <div class="controls">
        <h3>æ–‡æœ¬æ“ä½œ</h3>
        <div class="input-group">
          <label>èµ·å§‹ä½ç½®:</label>
          <input type="number" id="fromPos" value="0" min="0" />
        </div>
        <div class="input-group">
          <label>ç»“æŸä½ç½®:</label>
          <input type="number" id="toPos" value="10" min="0" />
        </div>
        <div class="input-group">
          <label>æ–°æ–‡æœ¬:</label>
          <textarea id="newText" placeholder="è¾“å…¥è¦æ›¿æ¢çš„æ–‡æœ¬...">
Hello World!</textarea
          >
        </div>
        <button onclick="setSelection()">è®¾ç½®é€‰ä¸­</button>
        <button onclick="replaceText()">æ›¿æ¢æ–‡æœ¬</button>
        <button onclick="suggestChange()">å»ºè®®ä¿®æ”¹</button>
      </div>

      <div class="controls">
        <h3>å»ºè®®ä¿®æ”¹ç®¡ç†</h3>
        <div class="input-group">
          <label>ä¿®æ”¹ID:</label>
          <input type="text" id="changeId" placeholder="ä»å»ºè®®ä¿®æ”¹å“åº”ä¸­è·å–" />
        </div>
        <button onclick="acceptChange()">æ¥å—ä¿®æ”¹</button>
        <button onclick="rejectChange()">æ‹’ç»ä¿®æ”¹</button>
      </div>

      <div class="controls">
        <h3>å¤–éƒ¨APIåˆ›å»ºé¡¹ç›®ç¤ºä¾‹</h3>
        <div
          style="
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
          "
        >
          <strong>APIä½¿ç”¨è¯´æ˜ï¼š</strong><br />
          1. è·å–API Tokenï¼šåœ¨Overleafè®¾ç½®ä¸­ç”ŸæˆAPI Token<br />
          2. è°ƒç”¨å¤–éƒ¨APIï¼šPOST /api/project<br />
          3. è¯·æ±‚å¤´ï¼šAuthorization: Bearer {token}<br />
          4. è¯·æ±‚ä½“ï¼š{"name": "é¡¹ç›®åç§°"}<br />
          5. å“åº”ï¼š{"success": true, "projectId": "é¡¹ç›®ID"}
        </div>
        <div class="input-group">
          <label>é¡¹ç›®åç§°:</label>
          <input
            type="text"
            id="externalProjectName"
            placeholder="è¾“å…¥æ–°é¡¹ç›®åç§°"
          />
        </div>
        <div class="input-group">
          <label>API Token:</label>
          <input
            type="password"
            id="apiToken"
            placeholder="è¾“å…¥æ‚¨çš„API Token"
          />
        </div>
        <button onclick="createProjectExternal()">é€šè¿‡å¤–éƒ¨APIåˆ›å»ºé¡¹ç›®</button>
        <button onclick="listProjectFiles()">åˆ—å‡ºé¡¹ç›®æ–‡ä»¶</button>
      </div>

      <div class="controls">
        <h3>æ–‡ä»¶æ“ä½œ</h3>
        <div class="input-group">
          <label>æ–‡ä»¶ID:</label>
          <input type="text" id="fileId" placeholder="è¾“å…¥è¦ä¸‹è½½çš„æ–‡ä»¶ID" />
        </div>
        <div class="input-group">
          <label>æ–‡ä»¶å:</label>
          <input
            type="text"
            id="downloadFileName"
            placeholder="å¯é€‰çš„è‡ªå®šä¹‰æ–‡ä»¶å"
          />
        </div>
        <button onclick="downloadFile()">ä¸‹è½½æ–‡ä»¶</button>

        <hr style="margin: 15px 0" />

        <div class="input-group">
          <label>é€‰æ‹©æ–‡ä»¶:</label>
          <input type="file" id="fileInput" accept="*/*" />
        </div>
        <div class="input-group">
          <label>ä¸Šä¼ æ–‡ä»¶å:</label>
          <input
            type="text"
            id="uploadFileName"
            placeholder="å¯é€‰çš„è‡ªå®šä¹‰æ–‡ä»¶å"
          />
        </div>
        <div class="input-group">
          <label>æ–‡ä»¶å¤¹ID:</label>
          <input
            type="text"
            id="folderId"
            placeholder="å¯é€‰ï¼Œç•™ç©ºåˆ™ä¸Šä¼ åˆ°æ ¹ç›®å½•"
          />
        </div>
        <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
      </div>

      <div class="controls">
        <h3>æ–‡ä»¶å¤¹æ“ä½œ</h3>
        <div class="input-group">
          <label>æ–‡ä»¶å¤¹åç§°:</label>
          <input type="text" id="folderName" placeholder="è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°" />
        </div>
        <div class="input-group">
          <label>çˆ¶æ–‡ä»¶å¤¹ID:</label>
          <input
            type="text"
            id="parentFolderId"
            placeholder="å¯é€‰ï¼Œç•™ç©ºåˆ™åœ¨æ ¹ç›®å½•åˆ›å»º"
          />
        </div>
        <button onclick="createFolder()">åˆ›å»ºæ–‡ä»¶å¤¹</button>
      </div>

      <div class="controls">
        <h3>æ–‡ä»¶é‡å‘½å</h3>
        <p style="color: #666; font-size: 12px; margin-bottom: 10px">
          æç¤ºï¼šæ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡»ä¸‹æ–¹æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ–‡ä»¶æ¥è‡ªåŠ¨å¡«å……è¡¨å•ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥æ–‡ä»¶ä¿¡æ¯ã€‚
        </p>
        <div class="input-group">
          <label>æ–‡ä»¶ID:</label>
          <input
            type="text"
            id="renameFileId"
            placeholder="è¾“å…¥è¦é‡å‘½åçš„æ–‡ä»¶ID"
          />
        </div>
        <div class="input-group">
          <label>æ–°æ–‡ä»¶å:</label>
          <input type="text" id="newFileName" placeholder="è¾“å…¥æ–°çš„æ–‡ä»¶å" />
        </div>
        <div class="input-group">
          <label>æ–‡ä»¶ç±»å‹ (å¯é€‰):</label>
          <select id="renameFileType">
            <option value="">è‡ªåŠ¨æ£€æµ‹</option>
            <option value="doc">æ–‡æ¡£ (doc)</option>
            <option value="fileRef">æ–‡ä»¶å¼•ç”¨ (fileRef)</option>
            <option value="folder">æ–‡ä»¶å¤¹ (folder)</option>
          </select>
          <small
            style="
              color: #666;
              font-size: 11px;
              display: block;
              margin-top: 2px;
            "
          >
            é€‰æ‹©"è‡ªåŠ¨æ£€æµ‹"å°†æ ¹æ®æ–‡ä»¶æ ‘æ•°æ®è‡ªåŠ¨ç¡®å®šç±»å‹
          </small>
        </div>
        <button onclick="renameFile()">é‡å‘½åæ–‡ä»¶</button>
      </div>

      <div class="controls">
        <h3>åˆ é™¤æ–‡ä»¶</h3>
        <p style="color: #666; font-size: 12px; margin-bottom: 10px">
          æç¤ºï¼šæ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡»ä¸‹æ–¹æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ–‡ä»¶æ¥è‡ªåŠ¨å¡«å……è¡¨å•ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥æ–‡ä»¶ä¿¡æ¯ã€‚
        </p>
        <div class="input-group">
          <label>æ–‡ä»¶ID:</label>
          <input
            type="text"
            id="deleteFileId"
            placeholder="è¾“å…¥è¦åˆ é™¤çš„æ–‡ä»¶ID"
          />
        </div>
        <div class="input-group">
          <label>æ–‡ä»¶ç±»å‹ (å¯é€‰):</label>
          <select id="deleteFileType">
            <option value="">è‡ªåŠ¨æ£€æµ‹</option>
            <option value="doc">æ–‡æ¡£ (doc)</option>
            <option value="fileRef">æ–‡ä»¶å¼•ç”¨ (fileRef)</option>
            <option value="folder">æ–‡ä»¶å¤¹ (folder)</option>
          </select>
          <small
            style="
              color: #666;
              font-size: 11px;
              display: block;
              margin-top: 2px;
            "
          >
            é€‰æ‹©"è‡ªåŠ¨æ£€æµ‹"å°†æ ¹æ®æ–‡ä»¶æ ‘æ•°æ®è‡ªåŠ¨ç¡®å®šç±»å‹
          </small>
        </div>
        <button onclick="deleteFile()" style="background-color: #dc3545; color: white;">åˆ é™¤æ–‡ä»¶</button>
      </div>

      <div class="controls">
        <h3>é¡¹ç›®æ–‡ä»¶åˆ—è¡¨</h3>
        <button onclick="refreshFileList()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
        <button onclick="setFileTreeDataForDemo()">è®¾ç½®æ¼”ç¤ºæ–‡ä»¶æ ‘æ•°æ®</button>
        <div
          id="fileList"
          class="log"
          style="height: 150px; margin-top: 10px"
        ></div>
      </div>

      <div class="controls">
        <h3>æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log" class="log"></div>
      </div>

      <div class="iframe-container">
        <iframe
          id="overleaf-editor"
          src="http://localhost/project/68e29d6cedafffc388a90203?auth=b3ZlcmxlYWY6b3ZlcmxlYWY="
          width="100%"
          height="600px"
          frameborder="0"
        >
        </iframe>
      </div>
    </div>

    <script>
      // é…ç½®
      const OVERLEAF_ORIGIN = 'http://localhost' // è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸå
      const IFRAME_ID = 'overleaf-editor'

      // çŠ¶æ€ç®¡ç†
      let isIframeLoaded = false
      let pendingCalls = new Map()
      let lastChangeId = null

      // æ—¥å¿—åŠŸèƒ½
      function log(message, type = 'info') {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = document.createElement('div')
        logEntry.innerHTML = `[${timestamp}] ${message}`
        logEntry.style.color =
          type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333'
        logElement.appendChild(logEntry)
        logElement.scrollTop = logElement.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
      }

      // æ¶ˆæ¯ç›‘å¬å™¨
      window.addEventListener('message', function (event) {
        const { type, callId, success, result, error } = event.data

        if (type === 'apiResponse' && pendingCalls.has(callId)) {
          const { resolve, reject } = pendingCalls.get(callId)
          pendingCalls.delete(callId)

          if (success) {
            log(`API è°ƒç”¨æˆåŠŸ: ${JSON.stringify(result)}`, 'success')
            resolve(result)
          } else {
            log(`API è°ƒç”¨å¤±è´¥: ${error}`, 'error')
            reject(new Error(error))
          }
        }
      })

      // iframe åŠ è½½å®Œæˆ
      document.getElementById(IFRAME_ID).addEventListener('load', function () {
        isIframeLoaded = true
        log('Overleaf ç¼–è¾‘å™¨å·²åŠ è½½', 'success')
      })

      // API è°ƒç”¨å‡½æ•°
      function callEditorApi(api, method, params = []) {
        console.log(api, method, params, 'call')
        if (!isIframeLoaded) {
          log('ç¼–è¾‘å™¨å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•', 'error')
          return Promise.reject(new Error('ç¼–è¾‘å™¨æœªåŠ è½½'))
        }

        return new Promise((resolve, reject) => {
          const callId =
            'call_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)

          pendingCalls.set(callId, { resolve, reject })

          const iframe = document.getElementById(IFRAME_ID)
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(
              {
                type: 'apiCall',
                api: api,
                method: method,
                params: params,
                callId: callId,
              },
              OVERLEAF_ORIGIN
            )

            log(`å‘é€ API è°ƒç”¨: ${api}.${method}(${JSON.stringify(params)})`)
          } else {
            reject(new Error('Iframe æœªæ‰¾åˆ°æˆ–æœªåŠ è½½'))
          }
        })
      }

      // è®¾ç½®æ–‡ä»¶æ ‘æ•°æ®çš„å‡½æ•°ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
      function setFileTreeDataForDemo() {
        // è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ–‡ä»¶æ ‘æ•°æ®ç»“æ„
        const mockFileTreeData = {
          _id: 'root-folder-id',
          name: '',
          folders: [
            {
              _id: 'folder-1',
              name: 'documents',
              folders: [],
              docs: [
                {
                  _id: 'doc-1',
                  name: 'main.tex',
                  path: '/main.tex',
                },
              ],
              fileRefs: [
                {
                  _id: 'file-1',
                  name: 'image.png',
                  path: '/image.png',
                },
              ],
            },
          ],
          docs: [
            {
              _id: 'doc-2',
              name: 'readme.tex',
              path: '/readme.tex',
            },
          ],
          fileRefs: [
            {
              _id: 'file-2',
              name: 'config.json',
              path: '/config.json',
            },
          ],
        }

        // è®¾ç½®å…¨å±€æ–‡ä»¶æ ‘æ•°æ®
        if (
          window.overleafEditorApi &&
          window.overleafEditorApi.setFileTreeData
        ) {
          window.overleafEditorApi.setFileTreeData(mockFileTreeData)
          log('æ–‡ä»¶æ ‘æ•°æ®å·²è®¾ç½®ç”¨äºæ¼”ç¤º', 'success')
        } else {
          log('setFileTreeData æ–¹æ³•ä¸å¯ç”¨', 'error')
        }
      }

      // å…·ä½“ API æ–¹æ³•
      async function getSelection() {
        try {
          const result = await callEditorApi('editor', 'getSelection')
          log(`é€‰ä¸­æ–‡æœ¬: ${JSON.stringify(result)}`, 'success')
        } catch (error) {
          log(`è·å–é€‰ä¸­æ–‡æœ¬å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function setSelection() {
        const from = parseInt(document.getElementById('fromPos').value)
        const to = parseInt(document.getElementById('toPos').value)

        try {
          await callEditorApi('editor', 'setSelection', [from, to])
          log(`é€‰ä¸­èŒƒå›´è®¾ç½®ä¸º: ${from}-${to}`, 'success')
        } catch (error) {
          log(`è®¾ç½®é€‰ä¸­èŒƒå›´å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function replaceText() {
        const from = parseInt(document.getElementById('fromPos').value)
        const to = parseInt(document.getElementById('toPos').value)
        const text = document.getElementById('newText').value

        try {
          await callEditorApi('editor', 'replaceText', [from, to, text])
          log(`æ–‡æœ¬æ›¿æ¢æˆåŠŸ: ${from}-${to} -> "${text}"`, 'success')
        } catch (error) {
          log(`æ–‡æœ¬æ›¿æ¢å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function suggestChange() {
        const from = parseInt(document.getElementById('fromPos').value)
        const to = parseInt(document.getElementById('toPos').value)
        const text = document.getElementById('newText').value

        try {
          const result = await callEditorApi('editor', 'suggestChange', [
            from,
            to,
            text,
          ])
          lastChangeId = result.changeId
          document.getElementById('changeId').value = result.changeId
          log(`å»ºè®®ä¿®æ”¹åˆ›å»ºæˆåŠŸï¼ŒID: ${result.changeId}`, 'success')
        } catch (error) {
          log(`åˆ›å»ºå»ºè®®ä¿®æ”¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function acceptChange() {
        const changeId =
          document.getElementById('changeId').value || lastChangeId

        if (!changeId) {
          log('è¯·å…ˆåˆ›å»ºå»ºè®®ä¿®æ”¹æˆ–è¾“å…¥ä¿®æ”¹ID', 'error')
          return
        }

        try {
          await callEditorApi('editor', 'acceptChange', [changeId])
          log(`å»ºè®®ä¿®æ”¹å·²æ¥å—: ${changeId}`, 'success')
        } catch (error) {
          log(`æ¥å—å»ºè®®ä¿®æ”¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function rejectChange() {
        const changeId =
          document.getElementById('changeId').value || lastChangeId

        if (!changeId) {
          log('è¯·å…ˆåˆ›å»ºå»ºè®®ä¿®æ”¹æˆ–è¾“å…¥ä¿®æ”¹ID', 'error')
          return
        }

        try {
          await callEditorApi('editor', 'rejectChange', [changeId])
          log(`å»ºè®®ä¿®æ”¹å·²æ‹’ç»: ${changeId}`, 'success')
        } catch (error) {
          log(`æ‹’ç»å»ºè®®ä¿®æ”¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      // ä¸‹è½½æ–‡ä»¶
      async function downloadFile() {
        const fileId = document.getElementById('fileId').value
        const fileName = document.getElementById('downloadFileName').value

        if (!fileId) {
          log('è¯·è¾“å…¥æ–‡ä»¶ID', 'error')
          return
        }

        try {
          const params = fileName ? [fileId, fileName] : [fileId]
          const result = await callEditorApi('editor', 'downloadFile', params)

          if (result.success && result.downloadUrl) {
            log(`æ–‡ä»¶ä¸‹è½½URLç”ŸæˆæˆåŠŸ: ${result.downloadUrl}`, 'success')
            // è‡ªåŠ¨æ‰“å¼€ä¸‹è½½é“¾æ¥
            window.open(result.downloadUrl, '_blank')
          } else {
            log(`æ–‡ä»¶ä¸‹è½½å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          log(`ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error')
        }
      }

      // ä¸Šä¼ æ–‡ä»¶
      async function uploadFile() {
        const fileInput = document.getElementById('fileInput')
        const fileName = document.getElementById('uploadFileName').value
        const folderId = document.getElementById('folderId').value

        if (!fileInput.files || fileInput.files.length === 0) {
          log('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error')
          return
        }

        const file = fileInput.files[0]

        try {
          const params = [file]

          if (fileName) {
            params.push(fileName)
          } else {
            params.push(undefined)
          }

          if (folderId) {
            params.push(folderId)
          } else {
            params.push(undefined)
          }

          const result = await callEditorApi('editor', 'uploadFile', params)

          if (result.success) {
            log(
              `æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å®ä½“ID: ${result.entityId}ï¼Œå“ˆå¸Œ: ${result.hash}`,
              'success'
            )
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            fileInput.value = ''
            document.getElementById('uploadFileName').value = ''
            document.getElementById('folderId').value = ''
          } else {
            log(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            if (result.error && result.error.includes('HTTP')) {
              log(`HTTPé”™è¯¯è¯¦æƒ…: ${result.error}`, 'error')
            }
          }
        } catch (error) {
          log(`ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function getDocument() {
        try {
          const result = await callEditorApi('editor', 'getDocument', [true])
          log(
            `æ–‡æ¡£å†…å®¹è·å–æˆåŠŸï¼Œé•¿åº¦: ${result.content.length} å­—ç¬¦`,
            'success'
          )
          log(
            `å»ºè®®ä¿®æ”¹æ•°é‡: ${result.changes ? result.changes.length : 0}`,
            'info'
          )
        } catch (error) {
          log(`è·å–æ–‡æ¡£å†…å®¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function recompile() {
        try {
          await callEditorApi('editor', 'recompile', [{}])
          log('é‡æ–°ç¼–è¯‘æˆåŠŸ', 'success')
        } catch (error) {
          log(`é‡æ–°ç¼–è¯‘å¤±è´¥: ${error.message}`, 'error')
        }
      }

      // å¤–éƒ¨APIåˆ›å»ºé¡¹ç›®åŠŸèƒ½
      async function createProjectExternal() {
        const projectName = document.getElementById('externalProjectName').value
        const apiToken = document.getElementById('apiToken').value

        if (!projectName) {
          log('è¯·è¾“å…¥é¡¹ç›®åç§°', 'error')
          return
        }

        if (!apiToken) {
          log('è¯·è¾“å…¥API Token', 'error')
          return
        }

        try {
          // ä½¿ç”¨å¤–éƒ¨APIåˆ›å»ºé¡¹ç›®
          const response = await fetch('http://localhost/api/project', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${apiToken}`,
            },
            body: JSON.stringify({
              name: projectName,
            }),
          })

          if (!response.ok) {
            const errorText = await response.text()
            log(
              `å¤–éƒ¨APIè¯·æ±‚å¤±è´¥: HTTP ${response.status} - ${errorText}`,
              'error'
            )
            return
          }

          const result = await response.json()

          if (result.success && result.projectId) {
            log(`é¡¹ç›®åˆ›å»ºæˆåŠŸï¼é¡¹ç›®ID: ${result.projectId}`, 'success')
            log(
              `é¡¹ç›®URL: ${window.location.origin}/project/${result.projectId}`,
              'info'
            )
            document.getElementById('externalProjectName').value = ''
            document.getElementById('apiToken').value = ''
          } else {
            log(`é¡¹ç›®åˆ›å»ºå¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          log(`åˆ›å»ºé¡¹ç›®å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function listProjectFiles() {
        try {
          const result = await callEditorApi('project', 'listProjectFiles', [])

          if (result.success && result.files) {
            log(
              `é¡¹ç›®æ–‡ä»¶åˆ—è¡¨è·å–æˆåŠŸï¼Œå…± ${result.files.length} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹`,
              'success'
            )
            displayFileList(result.files)
          } else {
            log(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          log(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function createFolder() {
        const folderName = document.getElementById('folderName').value
        const parentFolderId = document.getElementById('parentFolderId').value

        if (!folderName) {
          log('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°', 'error')
          return
        }

        try {
          const params = [folderName]
          if (parentFolderId) {
            params.push(parentFolderId)
          }

          const result = await callEditorApi('project', 'createFolder', params)

          if (result.success && result.folderId) {
            log(`æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼æ–‡ä»¶å¤¹ID: ${result.folderId}`, 'success')
            document.getElementById('folderName').value = ''
            document.getElementById('parentFolderId').value = ''
            // è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            await listProjectFiles()
          } else {
            log(`æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          log(`åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function renameFile() {
        const fileId = document.getElementById('renameFileId').value
        const newName = document.getElementById('newFileName').value
        const entityType = document.getElementById('renameFileType').value

        if (!fileId || !newName) {
          log('è¯·è¾“å…¥æ–‡ä»¶IDå’Œæ–°æ–‡ä»¶å', 'error')
          return
        }

        try {
          // æ„å»ºå‚æ•°æ•°ç»„ï¼Œå¦‚æœentityTypeä¸ºç©ºåˆ™ä¸ä¼ é€’
          const params = [fileId, newName]
          if (entityType) {
            params.push(entityType)
          }

          const result = await callEditorApi('project', 'renameFile', params)

          if (result.success) {
            log(
              `æ–‡ä»¶é‡å‘½åæˆåŠŸï¼${entityType ? ` (ç±»å‹: ${entityType})` : ''}`,
              'success'
            )
            document.getElementById('renameFileId').value = ''
            document.getElementById('newFileName').value = ''
            document.getElementById('renameFileType').value = ''
            // è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            await listProjectFiles()
          } else {
            log(`æ–‡ä»¶é‡å‘½åå¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          log(`é‡å‘½åæ–‡ä»¶å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function deleteFile() {
        const fileId = document.getElementById('deleteFileId').value
        const entityType = document.getElementById('deleteFileType').value

        if (!fileId) {
          log('è¯·è¾“å…¥æ–‡ä»¶ID', 'error')
          return
        }

        // ç¡®è®¤åˆ é™¤
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
          return
        }

        try {
          // æ„å»ºå‚æ•°æ•°ç»„ï¼Œå¦‚æœentityTypeä¸ºç©ºåˆ™ä¸ä¼ é€’
          const params = [fileId]
          if (entityType) {
            params.push(entityType)
          }

          const result = await callEditorApi('project', 'deleteFile', params)

          if (result.success) {
            log(
              `æ–‡ä»¶åˆ é™¤æˆåŠŸï¼${entityType ? ` (ç±»å‹: ${entityType})` : ''}`,
              'success'
            )
            document.getElementById('deleteFileId').value = ''
            document.getElementById('deleteFileType').value = ''
            // è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            await listProjectFiles()
          } else {
            log(`æ–‡ä»¶åˆ é™¤å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          }
        } catch (error) {
          log(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error')
        }
      }

      async function refreshFileList() {
        await listProjectFiles()
      }

      // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ - æ”¯æŒæ ‘ç»“æ„æ˜¾ç¤º
      function displayFileList(files) {
        const fileListElement = document.getElementById('fileList')
        fileListElement.innerHTML = ''

        if (files.length === 0) {
          fileListElement.innerHTML =
            '<div style="color: #666;">é¡¹ç›®ä¸­æ²¡æœ‰æ–‡ä»¶</div>'
          return
        }

        // é€’å½’æ˜¾ç¤ºæ–‡ä»¶æ ‘
        function renderFileTree(fileList, container, level = 0) {
          fileList.forEach(file => {
            const fileEntry = document.createElement('div')
            fileEntry.style.marginBottom = '5px'
            fileEntry.style.padding = '5px'
            fileEntry.style.border = '1px solid #ddd'
            fileEntry.style.borderRadius = '3px'
            fileEntry.style.backgroundColor =
              file.type === 'folder' ? '#f0f8ff' : '#f9f9f9'
            fileEntry.style.marginLeft = `${level * 20}px` // ç¼©è¿›æ˜¾ç¤ºå±‚çº§

            const icon = file.type === 'folder' ? 'ğŸ“' : file.type === 'doc' ? 'ğŸ“„' : 'ğŸ“'
            const size = file.size ? ` (${formatFileSize(file.size)})` : ''
            const modified = file.modified
              ? ` - ${new Date(file.modified).toLocaleString()}`
              : ''

            const entityId = file.entityId || file.id
            const entityType = file.entityType || file.type
            const idInfo = file.entityId
              ? `å®ä½“ID: ${file.entityId}`
              : `è·¯å¾„ID: ${file.id}`

            fileEntry.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1; cursor: pointer;" onclick="selectFileForRename('${entityId}', '${file.name}', '${entityType}')">
                  <span style="margin-right: 5px;">${icon}</span>
                  <strong>${file.name}</strong>
                  <span style="color: #666; font-size: 12px;">${file.path}${size}${modified}</span>
                  <br>
                  <span style="color: #888; font-size: 11px;">${idInfo} | ç±»å‹: ${entityType}</span>
                </div>
                <div>
                  <button onclick="copyToClipboard('${entityId}')" style="font-size: 10px; padding: 2px 6px; margin-left: 5px;">å¤åˆ¶ID</button>
                  <button onclick="selectFileForRename('${entityId}', '${file.name}', '${entityType}')" style="font-size: 10px; padding: 2px 6px; margin-left: 5px; background: #007bff; color: white; border: none; border-radius: 3px;">é‡å‘½å</button>
                  <button onclick="selectFileForDelete('${entityId}', '${file.name}', '${entityType}')" style="font-size: 10px; padding: 2px 6px; margin-left: 5px; background: #dc3545; color: white; border: none; border-radius: 3px;">åˆ é™¤</button>
                </div>
              </div>
            `

            container.appendChild(fileEntry)

            // å¦‚æœæœ‰å­æ–‡ä»¶ï¼Œé€’å½’æ˜¾ç¤º
            if (file.children && file.children.length > 0) {
              renderFileTree(file.children, container, level + 1)
            }
          })
        }

        renderFileTree(files, fileListElement)
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B'
        const k = 1024
        const sizes = ['B', 'KB', 'MB', 'GB']
        const i = Math.floor(Math.log(bytes) / Math.log(k))
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
      }

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            log(`å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${text}`, 'success')
          })
          .catch(err => {
            log(`å¤åˆ¶å¤±è´¥: ${err.message}`, 'error')
          })
      }

      // é€‰æ‹©æ–‡ä»¶è¿›è¡Œé‡å‘½å
      function selectFileForRename(fileId, fileName, entityType) {
        document.getElementById('renameFileId').value = fileId
        document.getElementById('newFileName').value = fileName
        document.getElementById('renameFileType').value = entityType

        log(
          `å·²é€‰æ‹©æ–‡ä»¶è¿›è¡Œé‡å‘½å: ${fileName} (ID: ${fileId}, ç±»å‹: ${entityType})`,
          'info'
        )

        // æ»šåŠ¨åˆ°é‡å‘½ååŒºåŸŸ
        const renameSection = document.querySelector(
          'h3:contains("æ–‡ä»¶é‡å‘½å")'
        )
        if (renameSection) {
          renameSection.scrollIntoView({ behavior: 'smooth' })
        }
      }

      function selectFileForDelete(fileId, fileName, entityType) {
        document.getElementById('deleteFileId').value = fileId
        document.getElementById('deleteFileType').value = entityType

        log(
          `å·²é€‰æ‹©æ–‡ä»¶è¿›è¡Œåˆ é™¤: ${fileName} (ID: ${fileId}, ç±»å‹: ${entityType})`,
          'info'
        )

        // æ»šåŠ¨åˆ°åˆ é™¤åŒºåŸŸ
        const deleteSection = document.querySelector(
          'h3:contains("åˆ é™¤æ–‡ä»¶")'
        )
        if (deleteSection) {
          deleteSection.scrollIntoView({ behavior: 'smooth' })
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
      window.addEventListener('load', function () {
        log('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾… Overleaf ç¼–è¾‘å™¨åŠ è½½...', 'info')
        log('è¯·ç¡®ä¿å°† iframe src æ›¿æ¢ä¸ºæ‚¨çš„å®é™… Overleaf é¡¹ç›® URL', 'info')
      })
    </script>
  </body>
</html>
